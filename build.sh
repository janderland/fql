#!/usr/bin/env bash
set -eo pipefail


function print_help {
  cat << END
build.sh is a facade for fenv (FoundationDB development environment).
It runs a set of optional tasks in the order specified below. This is
the same script used by CI/CD to build, test, and package FQL.

If the '--image build' flag is set then the script starts off by
building the extended fenv image with all build tools. The tag
is determined by the git tag/hash and the FDB version. This image
is used to run the 'generate' and 'verify' tasks below.

If the '--generate' flag is set then the script checks if the
code generated by 'go generate ./...' is up to date.

If the '--verify' flag is set then the script builds, lints, and
tests the codebase. This task interacts with an FDB docker
container which is automatically started by fenv.

If the --docs' flag is set then the documentation HTML will be
generated under the /docs directory.

If the '--image fql' flag is set then the script runs 'docker
build' for the 'fql' docker image. The tag is determined by the
git tag/hash and the FDB version.

If the '--run' flag is provided then all the args after this flag
are passed to an instance of the 'fql' docker image. Normally
this image expects a cluster file as the first argument but this
script takes care of starting an FDB cluster and providing the
cluster file as the first argument. Note that this is the same
FDB instance used by the 'verify' task.

  ./build.sh --run --write -q '/my/dir("hi")=nil'

After this, the script ends. If any of the requested tasks fail
then the script exits immediately.

Multiple image names can be specified on the '--image' flag by
separating them with commas.

  ./build.sh --image build,fql
END
}


# fail prints $1 to stderr and exits with code 1.

function fail {
  local RED='\033[0;31m' NO_COLOR='\033[0m'
  echo -e "${RED}ERR! ${1}${NO_COLOR}" >&2
  exit 1
}


# join_array joins the elements of the $2 array into a
# single string, placing $1 between each element.

function join_array {
  local sep="$1" out="$2"
  if shift 2; then
    for arg in "$@"; do
      out="${out}${sep}${arg}"
    done
  fi
  echo "$out"
}


# Change directory to repo root.

cd "${0%/*}"


# Parse the flags.

if [[ $# -eq 0 ]]; then
  print_help
  echo
  fail "At least one flag must be provided."
fi

while [[ $# -gt 0 ]]; do
  case $1 in
    --generate)
      VERIFY_GENERATION="x"
      shift 1
      ;;

    --verify)
      VERIFY_CODEBASE="x"
      shift 1
      ;;

    --docs)
      GENERATE_DOCS="x"
      shift 1
      ;;

    --image)
      for service in $(echo "$2" | tr "," "\n"); do
        case $service in
          build)
            IMAGE_BUILD="x"
            ;;
          fql)
            IMAGE_FQL="x"
            ;;
          *)
            fail "Invalid build target '$service'"
            ;;
        esac
      done
      shift 2
      ;;

    --run)
      shift 1
      RUN_FQL="x"
      FQL_ARGS=("$@")
      shift $#
      ;;

    --help)
      print_help
      exit 0
      ;;

    *)
      fail "Invalid flag '$1'"
  esac
done


# Build variables for fenv and docker commands.

# Set fenv environment variables
export FENV_FDB_VER="${FENV_FDB_VER:-6.2.30}"
export FENV_PROJECT_NAME="fql"

DOCKER_TAG="$(./fenv/docker_tag.sh)"
echo "DOCKER_TAG=${DOCKER_TAG}"
export DOCKER_TAG

# fenv command with common flags
FENV_CMD=(./fenv/fenv.sh --docker ./docker/Dockerfile.builder)


# Run the requested commands.

# Build the extended fenv image if requested
if [[ -n "$IMAGE_BUILD" ]]; then
  echo "Building extended fenv image..."
  (set -x; "${FENV_CMD[@]}" --build)
fi

# Execute build tasks (generate, verify, docs) using fenv
if [[ -n "$VERIFY_GENERATION" ]]; then
  echo "Verifying code generation..."
  (set -x; "${FENV_CMD[@]}" --exec ./scripts/verify_generation.sh)
fi

if [[ -n "$VERIFY_CODEBASE" ]]; then
  echo "Verifying codebase..."
  (set -x; "${FENV_CMD[@]}" --exec ./scripts/verify_codebase.sh)
fi

if [[ -n "$GENERATE_DOCS" ]]; then
  echo "Generating documentation..."
  (set -x; "${FENV_CMD[@]}" --exec ./scripts/generate_docs.sh)
fi

# Build the final fql image if requested
if [[ -n "$IMAGE_FQL" ]]; then
  echo "Building fql runtime image..."
  (set -x; docker build \
    -f ./docker/Dockerfile \
    -t "docker.io/janderland/fql:${DOCKER_TAG}" \
    --build-arg "FQL_VER=${DOCKER_TAG}" \
    --build-arg "FENV_FDB_VER=${FENV_FDB_VER}" \
    --build-arg "FENV_DOCKER_TAG=${FENV_FDB_VER}" \
    .)
fi

# Run fql interactively if requested
if [[ -n "$RUN_FQL" ]]; then
  echo "Running fql with args: ${FQL_ARGS[*]}"
  export FDB_DOCKER_IMAGE="foundationdb/foundationdb:${FENV_FDB_VER}"
  (set -x; docker compose run --rm fql 'docker:docker@{fdb}:4500' "${FQL_ARGS[@]}")
fi
